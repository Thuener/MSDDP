push!(LOAD_PATH, "../")
using H2SDDP
using Distributions
using Base.Test

## Teste para uma distribuição específica
Logging.info("Test with specific distribution")
srand(123)
N = 4
T = 11
K = 3
S = 100
r = zeros(N,K,S)
r[:,1,:] = [-0.047803	0.017789	-0.012784	0.0593	0.034408	-0.077532	0.026338	0.097645	0.019933	0.011279	0.062471	-0.01727	-0.0011786	0.062907	-0.036479	-0.020657	0.090579	0.033521	-0.032523	-0.039451	-0.0096568	0.031083	0.013086	0.0075841	0.044097	-0.0043641	0.029556	0.041833	0.0019632	-0.0091934	0.1334	-0.035267	-0.028671	-0.025528	0.034745	-0.010653	-0.040746	0.022825	0.028967	0.050838	0.073137	-0.00010582	-0.013439	0.031937	-0.0032199	0.045082	0.0083449	-0.0078038	-0.071718	0.025297	0.018743	0.0052104	-0.016784	0.012031	0.066276	0.024001	-0.046663	0.0045457	0.037817	-0.064643	-0.059963	0.027437	-0.015578	-0.02185	-0.032628	0.0518	0.018157	-0.051617	-0.045065	0.059798	0.00061541	-0.1136	0.0028286	0.010077	-0.048423	0.013808	0.040759	0.049533	-0.0062554	0.0069336	0.016661	0.038729	0.056231	-0.030455	-0.023668	0.021395	-0.019313	0.036418	-0.025864	-0.012787	0.046384	0.070814	0.05383	0.077134	0.08534	0.015592	-0.05649	-0.0052641	0.017789	0.062907;
 -0.025402	0.013817	0.0011541	0.068684	0.034259	-0.12163	0.017234	0.074797	0.0262	0.032665	0.061635	-0.0050221	0.024787	0.071664	0.022943	-0.07151	0.13363	0.014928	0.010706	-0.027199	-0.061372	0.059501	0.00039546	0.0042757	0.0055574	-0.012059	0.11741	0.083492	0.035002	-0.016805	0.089731	-0.018685	-0.092512	-0.088859	-0.030158	0.012372	-0.08436	-0.0019528	0.055928	-0.028194	0.043272	-0.031528	0.031681	0.099333	0.048087	0.054056	0.019901	-0.064086	-0.038038	0.038345	-0.077603	0.065709	0.029838	-0.040109	0.016412	0.045458	-0.0080449	-0.0059784	-0.045268	-0.056362	-0.042717	0.018677	-0.020969	-0.0090843	-0.014665	0.03577	-0.0034661	-0.046386	0.028777	0.049789	0.0019856	-0.025568	-0.010231	0.11132	-0.11037	-0.01907	0.08456	0.10267	0.013527	-0.049654	-0.01284	-0.050924	0.042094	-0.03363	0.040231	0.053548	0.0027245	0.02153	-0.068746	-0.023374	0.0066582	0.068223	0.047627	0.062946	0.077461	-0.035705	-0.055753	0.0092775	0.013817	0.071664;
 -0.025648	-0.018534	0.034496	0.050426	0.019783	-0.11941	-0.0064888	0.099508	0.028247	0.041496	0.087705	-0.025643	-0.019325	0.082969	0.007065	-0.05791	0.11317	0.052058	-0.030327	-0.058449	-0.0084342	0.046039	0.026133	0.0042799	0.039304	-0.001877	0.067824	0.076843	-0.035948	-0.042837	0.12741	-0.037863	-0.05395	-0.022043	0.024249	0.029223	-0.078845	0.03736	0.054061	0.033129	0.055453	-0.0015475	0.0087942	0.047481	-0.046751	0.071039	-0.011751	-0.011108	-0.090414	0.036015	-0.032419	0.00010872	-0.034102	0.0062591	0.050024	-0.020267	0.019541	-0.066255	-0.003166	-0.073998	-0.063319	0.020869	0.012766	-0.023543	-0.027614	0.031086	0.0012737	-0.08396	-0.027018	0.06355	-0.016614	-0.0088077	-0.0051143	0.022903	-0.050283	0.01021	0.066687	0.06009	-0.043529	-0.01542	0.016265	0.017516	0.092661	-0.10273	0.0026732	0.044561	0.011741	0.033231	-0.040709	-0.013842	0.014256	0.057628	0.022244	0.077396	0.10359	0.043089	-0.068905	-0.048038	-0.018534	0.082969;
 -0.03084	0.031311	-0.019297	0.018973	0.053998	-0.10091	0.023162	0.090288	0.027526	-0.007947	0.046692	-0.028089	-0.033316	0.028804	-0.0034097	-0.044302	0.026105	0.010091	0.011254	-0.0048305	-0.0028086	0.039512	0.015416	-0.019569	0.045636	-0.015451	0.056563	0.059892	-0.022325	-0.040198	0.11674	0.0037398	-0.034659	-0.042944	0.0065792	0.018955	-0.010782	0.0012395	0.035559	0.013688	0.055489	0.011848	-0.056288	0.022339	0.016339	0.043159	-0.006937	-0.018496	-0.013228	0.068268	-0.050707	0.0081751	-0.0004425	0.020487	0.072542	0.0074867	0.032322	-0.005502	-0.0014185	-0.083544	-0.023276	-0.011939	-0.020707	0.0019876	-0.01475	0.033586	0.0033125	-0.028956	-0.072827	0.084894	0.019197	-0.059549	-0.0090552	0.052943	-0.038789	0.030139	0.040947	0.03517	0.017514	0.012578	0.024236	-0.048067	0.049461	-0.026757	0.0054565	0.042479	-0.054202	0.065646	-0.025232	-0.016083	-0.031841	0.063438	0.038053	0.076714	0.051926	0.026403	-0.063351	-0.03585	0.031311	0.028804]
 r[:,2,:] = r[:,1,:]
 r[:,3,:] = r[:,1,:]
 #r = exp(r)-1
α = 0.95
x_ini = zeros(N)
x0_ini = 1
c = 0.00
M = 9999999#(1+maximum(r))^(T-1)*(sum(x_ini)+x0_ini)-(sum(x_ini)+x0_ini);
γ = 0.1
#Parâmetros
S_LB = 1000
S_FB = 5
GAPP = 1 # GAP mínimo em porcentagem
Max_It = 100
α_lB = 0.9

dH  = H2SDDPData( N, T, K, S, α, x_ini, x0_ini, c, M, γ, S_LB, S_FB, GAPP, Max_It, α_lB )

# Probabilidades (condicionais a cada estado) para cada cenario p(S|K)
p = [0.01906998	0.01630884	0.00797983	0.00461738	0.03170003	0.00002421	0.02784677	0.00672797	0.05331259	0.01394163	0.00993677	0.03492955	0.00428283	0.00460965	0.00112364	0.00020668	0.00001158	0.01340553	0.00289097	0.00862598	0.00016561	0.00882714	0.03045968	0.04065435	0.00813226	0.03935227	0.0000116	0.00078967	0.00044865	0.01239416	0.00071778	0.01511384	0.00006208	0.00003124	0.00017803	0.01375807	0.00009706	0.00951572	0.01034115	0.00004719	0.01843051	0.00486779	0.0008483	0.00005935	0.00007635	0.01684803	0.02268044	0.00013416	0.0005807	0.01535402	0.00000397	0.00012992	0.00075737	0.00042409	0.00298067	0.00083697	0.00028901	0.00094901	0.00003158	0.00525928	0.0072068	0.0272947	0.01151415	0.03354434	0.03140599	0.03392192	0.03229367	0.00352589	0.0000372	0.01871067	0.03575106	0.00001194	0.03955568	0.00000316	0.00002292	0.00627471	0.00067102	0.00009768	0.00289577	0.0002999	0.01120674	0.00000603	0.00461297	0.00036397	0.00046248	0.00792973	0.00763378	0.02455096	0.00043724	0.02964457	0.0010657	0.01475722	0.01610293	0.01754461	0.00364023	0.00008545	0.00744284	0.0023634	0.01630884	0.00460965;
 0.00801313	0.00752706	0.00235334	0.00982228	0.01294437	0.00059681	0.01345273	0.00303363	0.0346196	0.01174435	0.01126078	0.02679377	0.0094929	0.01013678	0.00219039	0.00693272	0.00055287	0.01447917	0.0067277	0.01023533	0.00881294	0.02185845	0.02765675	0.02683841	0.01583052	0.03189507	0.00115821	0.00684467	0.00258065	0.01019855	0.0002346	0.0127677	0.00583267	0.00174075	0.00723248	0.00599215	0.00434951	0.01528209	0.01937244	0.00289573	0.00826893	0.02275679	0.00191848	0.00578689	0.00039304	0.01674818	0.02267527	0.00805782	0.00121857	0.00694391	0.00016765	0.00679692	0.00703464	0.01267154	0.00425655	0.00213622	0.00008731	0.00056172	0.00209045	0.00343748	0.00798029	0.01878343	0.00788436	0.02518322	0.02204292	0.01622119	0.03178819	0.00693446	0.00061838	0.00585597	0.02362458	0.00000644	0.03679172	0.00024871	0.00170256	0.01987056	0.01211121	0.00719626	0.00374303	0.01242556	0.02535048	0.00007354	0.00501869	0.00041144	0.00572273	0.0156562	0.00215692	0.01018136	0.01425708	0.0321883	0.00097869	0.00830749	0.0071947	0.00774791	0.00567987	0.00197235	0.00882646	0.00330647	0.00752706	0.010136809999999817;
 0.0172495	0.01694296	0.01590737	0.00903998	0.01593595	0.00122963	0.01837271	0.0061381	0.02101523	0.01352078	0.01135051	0.02070005	0.01102666	0.00871841	0.00546381	0.00347089	0.00048069	0.01525484	0.0103289	0.01675545	0.00324645	0.01036146	0.018967	0.02047332	0.00868716	0.02114236	0.00021538	0.00435085	0.00832348	0.01664632	0.00199083	0.01747261	0.0011914	0.00119632	0.00274671	0.01588879	0.00253338	0.01408624	0.01106059	0.00118131	0.01020216	0.0100898	0.00404818	0.00098247	0.00450103	0.01345715	0.01866994	0.00285064	0.00978443	0.01203666	0.00018162	0.0028562	0.00803199	0.0039365	0.00425691	0.01060012	0.00704663	0.01406791	0.00082177	0.0111891	0.01506343	0.0171931	0.01743786	0.02103896	0.02041476	0.0159435	0.01774602	0.0146904	0.00105101	0.00999586	0.0206499	0.00075141	0.02050798	0.00009106	0.0006995	0.00955039	0.00410903	0.00173147	0.01484198	0.003063	0.01205967	0.0003603	0.01138893	0.01269072	0.00399348	0.01011621	0.01093017	0.01250114	0.00485291	0.01957154	0.00636757	0.01062481	0.01402139	0.00975242	0.00769503	0.00335094	0.01360627	0.01360891	0.01694296	0.00871841]'
# prob iniciais
prob_ini = [0.04652593; 0.95209014;0.00138393]
# Matriz de transicao  (K_t x K_(t+1))
P_K = [0.97856492 0.00951288 0.05596537;
       0.00726958 0.98253836 0.01542020;
       0.01416550 0.00794877 0.92861443]'

dM = HMMData( r, p, prob_ini, P_K )

LB, UB = SDDP(dH, dM)
@test std(LB) ≈ 0.008849285301492187
@test mean(LB) ≈ 0.11897870830163698
@test UB ≈ 0.11897356098369039

dH.γ = 0.01
LB, UB = SDDP(dH, dM)
@test std(LB) ≈ 0.0023132720781265555
@test mean(LB) ≈ 0.023642756928825243
@test UB ≈ 0.023693971638959622
